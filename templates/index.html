<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Docker Log Monitor</title>
    <!-- Link to external stylesheet if you create one -->
    <!-- <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}"> -->
    <style>
        /* Basic styling */
        body {
            font-family: sans-serif;
            line-height: 1.6;
            margin: 0; /* Remove default margin */
            padding: 10px; /* Add padding for smaller screens */
            background-color: #f4f4f4;
            color: #333;
        }
        /* Add box-sizing globally */
        *, *:before, *:after {
            box-sizing: border-box;
        }
        .container {
            background: #fff;
            padding: 15px; /* Slightly reduce padding */
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 15px; /* Reduce margin */
            max-width: 1200px; /* Optional: Max width for very large screens */
            margin-left: auto; /* Center container */
            margin-right: auto; /* Center container */
        }
        h1, h2 {
            color: #333;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
            margin-top: 0; /* Adjust top margin */
            margin-bottom: 10px; /* Reduce bottom margin */
        }
        h1 { font-size: 1.6em; } /* Slightly larger H1 */
        h2 { margin-top: 20px;} /* Add space above H2 */

        pre {
            background: #eee;
            padding: 10px;
            border-radius: 4px;
            white-space: pre-wrap; /* Ensures text wraps */
            word-wrap: break-word; /* Ensures long words break */
            font-size: 0.85em; /* Slightly smaller */
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ddd;
        }

        /* --- Top Header Section Styles --- */
        .scan-info-header {
            display: flex;
            justify-content: space-between; /* Pushes items apart */
            align-items: flex-start; /* Align items to the top */
            flex-wrap: wrap; /* Allow wrapping on smaller screens */
            gap: 15px; /* Add space between left/right content when wrapped */
            margin-bottom: 15px; /* Space below header section */
        }
        .header-content {
            flex-basis: 60%; /* Give more space to left content initially */
            min-width: 250px; /* Prevent it getting too small */
        }
        .header-content p { margin: 5px 0; font-size: 0.9em; color: #555; }

        .header-actions {
            flex-basis: 35%; /* Remaining space */
            min-width: 150px; /* Adjusted min-width */
            display: flex;
            flex-direction: column; /* Stack links vertically */
            align-items: flex-end; /* Align items to the right */
            gap: 8px; /* Space between links */
        }
        .header-link { /* Style for Settings/Help links */
            font-size: 0.9em;
            color: #007bff;
            text-decoration: none;
            padding: 3px 0; /* Reduced vertical padding */
            white-space: nowrap; /* Prevent wrapping */
        }
        .header-link:hover { text-decoration: underline; }
        /* --- End Top Header Section Styles --- */


        /* Scan Running Indicator */
        .scan-in-progress {
            color: #0056b3;
            font-size: 0.9em;
            font-weight: bold;
            background-color: #e7f3ff;
            padding: 5px 10px;
            border-radius: 4px;
            display: inline-block;
            margin-top: 5px;
            margin-bottom: 5px;
        }

        /* Flash Messages */
        .flash { padding: 10px; margin-bottom: 15px; border-radius: 4px; }
        .flash.success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .flash.error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .flash.info { background-color: #cce5ff; color: #004085; border: 1px solid #b8daff; }
        .flash.warning { background-color: #fff3cd; color: #856404; border: 1px solid #ffeeba; }

        /* Scheduler Controls */
        .scheduler-controls {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #eee;
            display: flex; /* Use flexbox for buttons */
            flex-wrap: wrap; /* Allow buttons to wrap */
            gap: 10px; /* Space between buttons/forms */
            align-items: center; /* Align items vertically */
        }
        .scheduler-controls form { display: inline-block; margin: 0;} /* Remove bottom margin from forms */
        .scheduler-controls button {
            padding: 8px 12px;
            cursor: pointer;
            border-radius: 4px;
            border: none;
            font-weight: bold;
            white-space: nowrap; /* Prevent text wrapping inside buttons */
        }
        .button-pause { background-color: #ffc107; color: #333; }
        .button-pause:hover { background-color: #e0a800; }
        .button-resume { background-color: #28a745; color: white; }
        .button-resume:hover { background-color: #218838; }
        .button-stop { background-color: #dc3545; color: white; }
        .button-stop:hover { background-color: #c82333; }
        .button-start-now { background-color: #17a2b8; color: white; }
        .button-start-now:hover { background-color: #138496; }
        .scheduler-controls p {
             margin: 0; /* Remove margin from status messages */
             font-size: 0.9em;
             color: #6c757d;
             flex-basis: 100%; /* Allow status text to take full width if wrapped */
             margin-top: 5px; /* Add a little space if it wraps */
        }


        /* Container List Styles */
        .container-list { list-style: none; padding: 0; }
        .container-item {
            background-color: #fff;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin-bottom: 15px;
            padding: 15px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            border-left: 5px solid transparent; /* Default border */
            /* Use data-status colors for the left border */
            &[data-status="healthy"] { border-left-color: {{ color_settings.get('color_healthy', '#28a745') }}; }
            &[data-status="unhealthy"] { border-left-color: {{ color_settings.get('color_unhealthy', '#dc3545') }}; }
            &[data-status="pending"] { border-left-color: {{ color_settings.get('color_pending', '#ffc107') }}; opacity: 0.9; }
            &[data-status*="error"] { border-left-color: {{ color_settings.get('color_error', '#fd7e14') }}; }
            &[data-status="awaiting_scan"] { border-left-color: {{ color_settings.get('color_awaiting_scan', '#6f42c1') }}; }
        }

        .container-header {
            display: flex;
            align-items: center;
            flex-wrap: wrap; /* Allow wrapping on small screens */
            gap: 10px; /* Add gap between items */
            margin-bottom: 10px;
        }
        .container-name {
            font-weight: bold;
            font-size: 1.1em;
            word-break: break-all; /* Break long container names */
        }
        /* --- MODIFIED: Style for Container Name Link --- */
        .container-name a {
            color: inherit; /* Inherit color from parent */
            text-decoration: none;
        }
        .container-name a:hover {
            text-decoration: underline;
            color: #0056b3; /* Optional: change color on hover */
        }
        /* --- END MODIFIED --- */

        .container-id-short { /* Style for the short ID */
            font-size: 0.85em;
            color: #666;
            word-break: keep-all; /* Prevent breaking ID */
        }
        .status-dot {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            flex-shrink: 0; /* Prevent dot from shrinking */
            margin-right: 5px; /* Space between dot and name */
            /* Use data-status colors for the dot background */
            &.status-healthy { background-color: {{ color_settings.get('color_healthy', '#28a745') }}; box-shadow: 0 0 5px {{ color_settings.get('color_healthy', '#28a745') }}; }
            &.status-unhealthy { background-color: {{ color_settings.get('color_unhealthy', '#dc3545') }}; box-shadow: 0 0 5px {{ color_settings.get('color_unhealthy', '#dc3545') }}; }
            &.status-pending { background-color: {{ color_settings.get('color_pending', '#ffc107') }}; box-shadow: 0 0 5px {{ color_settings.get('color_pending', '#ffc107') }}; }
            &.status-error { background-color: {{ color_settings.get('color_error', '#fd7e14') }}; box-shadow: 0 0 5px {{ color_settings.get('color_error', '#fd7e14') }}; }
            &.status-awaiting { background-color: {{ color_settings.get('color_awaiting_scan', '#6f42c1') }}; box-shadow: 0 0 5px {{ color_settings.get('color_awaiting_scan', '#6f42c1') }}; }
        }

        /* Abnormality details section */
        .abnormality-details {
             margin-top: 10px;
             padding-top: 10px;
             border-top: 1px dashed #eee;
             display: block; /* Always block, content inside controls visibility */
        }

        .details-section { margin-bottom: 10px; }
        .details-section strong { display: block; margin-bottom: 5px; color: #444; }
        .details-section small, .status-message small {
            font-size: 0.85em;
            color: #666;
        }
        .status-message { /* Container for non-detailed status messages */
            margin-top: 10px;
        }

        /* --- MODIFIED: Manage Link & DB ID Error Styles --- */
        .manage-link {
            font-size: 0.9em;
            margin-left: auto; /* Pushes link to the right */
            padding: 3px 8px;
            border: 1px solid #007bff;
            color: #007bff;
            text-decoration: none;
            border-radius: 4px;
            white-space: nowrap;
        }
        .manage-link:hover { background-color: #e7f3ff; }
        .db-id-error-badge {
             font-size: 0.8em;
             padding: 2px 5px;
             background-color: #6c757d;
             color: white;
             border-radius: 3px;
             margin-left: auto; /* Push to right like the button */
             white-space: nowrap;
        }
        /* --- END MODIFIED --- */

        .timestamp { font-size: 0.8em; color: #777; margin-top: 5px; display: block;}


        /* --- Responsive Styles --- */
        @media (max-width: 768px) {
            body { padding: 5px; }
            .container { padding: 10px; }
            h1 { font-size: 1.4em; }
            h2 { font-size: 1.2em; }

             /* Stack header content and actions vertically on medium screens */
            .scan-info-header { flex-direction: column; align-items: stretch; }
            .header-actions { align-items: flex-start; } /* Align actions left when stacked */

            .scheduler-controls { justify-content: center; } /* Center buttons */
            .scheduler-controls button { flex-grow: 1; /* Allow buttons to grow */ }

            .container-header { gap: 8px; }
            .container-name { font-size: 1em; flex-grow: 1; }
            .manage-link, .db-id-error-badge { margin-left: 0; margin-top: 5px; width: auto; /* Don't make full width */ }
            pre { font-size: 0.8em; }
        }

        @media (max-width: 480px) {
             h1 { font-size: 1.3em;}
             .header-content p { font-size: 0.85em; }
             .container-name { font-size: 0.95em; }
             .container-id-short { display: none; } /* Hide short ID */
             .scheduler-controls button { min-width: 120px; } /* Ensure buttons have min width */
        }

    </style>
</head>
<body>
    <!-- Section for Scan Info and Controls -->
    <div class="container scan-info">
        <!-- Header Wrapper -->
        <div class="scan-info-header">
            <div class="header-content">
                <h1>Docker Container Health</h1>
                <p>Last Scan Status: {{ scan_status if scan_status else "Not run yet" }}</p>
                {% if scan_is_running %}
                    <p class="scan-in-progress"><em>Scan currently in progress...</em></p>
                {% endif %}
                <p>Next Scan scheduled around: {{ next_scan_time if next_scan_time else "N/A" }} (Times in {{ timezone }})</p>
            </div>

            <div class="header-actions">
                <!-- Settings Link -->
                <a href="{{ url_for('ui.settings') }}" class="header-link">Settings</a>
                <!-- Help Link -->
                <a href="{{ url_for('ui.help_page') }}" class="header-link">Help / Manual</a>
            </div>
        </div> <!-- End scan-info-header -->

         <!-- Display Flash Messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="flash {{ category }}">{{ message }}</div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        <!-- Scheduler Control Buttons -->
        <div class="scheduler-controls">
            <!-- Pause/Resume Schedule Buttons -->
            {% if job_state == 'running' %}
                <form method="POST" action="{{ url_for('pause_schedule') }}">
                    <button type="submit" class="button-pause">Pause Schedule</button>
                </form>
            {% elif job_state == 'paused' %}
                <form method="POST" action="{{ url_for('resume_schedule') }}">
                    <button type="submit" class="button-resume">Resume Schedule</button>
                </form>
            {% endif %}

            <!-- Stop Current Scan Button -->
            {% if scan_is_running %}
                <form method="POST" action="{{ url_for('stop_current_scan') }}">
                    <button type="submit" class="button-stop">Stop Current Scan</button>
                </form>
            {% endif %}

            <!-- Start Scan Now Button -->
            {% if not scan_is_running and job_state != 'scheduler_stopped' and job_state != 'error' %}
                <form method="POST" action="{{ url_for('trigger_scan') }}">
                    <button type="submit" class="button-start-now">Start Scan Now</button>
                </form>
            {% endif %}

            <!-- Status Messages for scheduler/job state -->
            {% if job_state == 'stopped' %}
                <p><em>Scan job is stopped (not scheduled). Restart application to reschedule.</em></p>
            {% elif job_state == 'scheduler_stopped' %}
                <p><em>Scheduler is not running. Restart application.</em></p>
            {% elif job_state == 'error' %}
                 <p><em>Error checking scan job status.</em></p>
            {% endif %}
        </div><!-- End scheduler-controls -->

    </div><!-- End scan-info container -->


    <!-- Section for the Container List -->
    <div class="container">
        <h2>Container Status</h2>
        {% if container_statuses %}
            <ul class="container-list">
                {% for container_id, data in container_statuses.items() %}
                    {# Add data-status attribute for easier CSS targeting and colors #}
                    <li class="container-item" data-status="{{ data.status }}">
                        <div class="container-header">
                            {# Status Dot #}
                            {% if data.status == 'healthy' %}<span class="status-dot status-healthy" title="Healthy"></span>
                            {% elif data.status == 'unhealthy' %}<span class="status-dot status-unhealthy" title="Unhealthy"></span>
                            {% elif data.status == 'pending' %}<span class="status-dot status-pending" title="Scan Pending"></span>
                            {% elif data.status == 'awaiting_scan' %}<span class="status-dot status-awaiting" title="Awaiting Scan"></span>
                            {% else %}<span class="status-dot status-error" title="{{ data.status | replace('_', ' ') | title }}"></span>
                            {% endif %}

                            {# Name (linked) and ID #}
                            {# --- MODIFIED: Wrap name in link --- #}
                            <span class="container-name">
                                <a href="{{ url_for('ui.container_history', container_id=container_id) }}" title="View history for {{ data.name }}">
                                    {{ data.name }}
                                </a>
                            </span>
                            <span class="container-id-short">({{ container_id[:12] }})</span>

                            {# --- MODIFIED: Conditional Manage Link / DB ID Error --- #}
                            {% if data.status == 'unhealthy' %}
                                {% if data.db_id %} {# Check if db_id is not None and truthy #}
                                    <a href="{{ url_for('ui.manage_abnormality', abnormality_id=data.db_id) }}" class="manage-link">Manage Issue</a>
                                {% else %}
                                     {# Optionally show something if status is unhealthy but db_id is missing #}
                                     <span class="db-id-error-badge" title="Cannot manage: DB ID missing, check logs.">DB ID Err</span>
                                {% endif %}
                            {% endif %}
                            {# --- END MODIFIED --- #}
                        </div> {# End container-header #}

                        {# Abnormality Details / Status Messages #}
                        <div class="abnormality-details">
                           {# --- MODIFIED: Display logic based on status and details --- #}
                           {% if data.status == 'unhealthy' and data.details %}
                                {# Display analysis and snippet for unhealthy #}
                                <div class="details-section">
                                    <strong>Ollama Analysis:</strong>
                                    {{ data.details.analysis }}
                                </div>
                                {% if data.details.snippet %}
                                <div class="details-section">
                                    <strong>Log Snippet:</strong>
                                    <pre>{{ data.details.snippet }}</pre>
                                </div>
                                {% endif %}
                                {% if data.details.timestamp %}
                                <div class="details-section">
                                    <small>Detected/Updated: {{ data.details.timestamp.strftime('%Y-%m-%d %H:%M:%S') if data.details.timestamp else 'N/A' }}</small>
                                </div>
                                {% endif %}
                            {% elif data.status in ['error_fetching_logs', 'error_analysis', 'error_db_log', 'error_db_lookup'] %}
                                 {# Display error details #}
                                 <div class="details-section">
                                     <strong>Status Detail:</strong>
                                     <small>{{ data.details.analysis | truncate(150) if data.details else data.status | replace('_', ' ') | title }}</small>
                                     {% if data.details and data.details.timestamp %}
                                         <span class="timestamp">Time: {{ data.details.timestamp.strftime('%Y-%m-%d %H:%M:%S') if data.details.timestamp else 'N/A' }}</span>
                                     {% endif %}
                                 </div>
                            {% elif data.status == 'resolved' and data.db_id %}
                                {# Link to the resolved issue #}
                                <div class="status-message">
                                     <small>Last issue (<a href="{{ url_for('ui.manage_abnormality', abnormality_id=data.db_id) }}" title="View resolved issue details">#{{ data.db_id }}</a>) was resolved.</small>
                                </div>
                            {% elif data.status == 'ignored' and data.db_id %}
                                {# Link to the ignored issue #}
                                <div class="status-message">
                                     <small>Last issue (<a href="{{ url_for('ui.manage_abnormality', abnormality_id=data.db_id) }}" title="View ignored issue details">#{{ data.db_id }}</a>) was ignored.</small>
                                </div>
                            {% elif data.status == 'healthy' and data.db_id %}
                                {# Healthy now, but linked to a previous resolved/ignored issue #}
                                <div class="status-message">
                                     <small>Normal scan. Previous issue: <a href="{{ url_for('ui.manage_abnormality', abnormality_id=data.db_id) }}" title="View previous issue details">#{{ data.db_id }}</a>.</small>
                                </div>
                            {% elif data.status == 'awaiting_scan' %}
                                <div class="status-message">
                                    <small>Awaiting next scan after status change or startup.</small>
                                </div>
                           {% elif data.status == 'healthy' %}
                                <div class="status-message">
                                    <small>Normal - No issues detected in last scan.</small>
                                </div>
                           {% elif data.status == 'pending' %}
                                <div class="status-message">
                                    <small>Scan pending...</small>
                                </div>
                            {% endif %}
                           {# --- END MODIFIED --- #}
                        </div> {# End abnormality-details #}
                    </li>
                {% endfor %} {# End of container loop #}
            </ul>
        {% else %}
            <p>No running containers detected or initial scan pending.</p>
        {% endif %} {# End of container_statuses check #}
    </div> <!-- End container list container -->

    <!-- Auto-refresh script -->
    <script>
        // Refresh every 60 seconds ONLY if a scan is NOT currently running
        var isScanRunning = {{ scan_is_running | tojson }}; // Use tojson filter for safety
        if (!isScanRunning) {
            // Add check for modal existence/visibility if needed in future
            setTimeout(() => { window.location.reload(); }, 60000); // 60 seconds
        } else {
            console.log("Scan is running, auto-refresh deferred.");
            // Optional: Check again later if scan finishes
            // setTimeout(() => { if (!document.body.classList.contains('modal-open')) window.location.reload(); }, 15000); // Check again after 15s
        }
    </script>
</body>
</html>
